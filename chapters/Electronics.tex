\chapter{Electronics}

CosmicWatches have to be mainly low-cost and easy to build, in order to achieve this the components selected for the construction have been carefully curated to make sure this restrictions were met. This however might be greatly responsible for some of the odd features found while testing the detector, like the lack of linearity. The full KiCad project can be found in the GitHub repository: \href{https://github.com/anvargasl/CosmicWatch-gamma-spectroscopy-PCB}{CosmicWatch-gamma-spectroscopy-PCB}.

\section{Amplifier}

An op-amp on its own amplifies the voltage difference between the non-inverting and inverting inputs by its internal gain $A_{int}$, having then $V_{out}=A_{int}(V_+ - V_-)$. In this case, however, we are interested in controlling the gain of the circuit and therefore the amplification. In order to achieve this we introduce a feedback loop in the op-amp through $R4$ and $R6$, which controls how much of the output voltage is fed back into the op-amp. The theoretical amplification is therefore given by $V_{out}=(1+R6/R4)V_{in}$. A simple schematic showcasing the component arrangement is shown in Figure \ref{circ:amplifier}.
\begin{figure}[H]
    \centering
    \begin{circuitikz}[scale=0.8]
        \draw
        (0,0) node[op amp,yscale=-1] (opamp) {}
        (opamp.+) node[left]{$V_{in}$}
        (opamp.-) node[left]{} to[short] ++(0, -2) 
        node[](gain){} to[R, l_=$R_4$] ++(-3, 0) node[ground]{}
        (gain) to[short, *-] ++(0.1, 0) to[R, l=$R_6$] ++(2.7, 0)
        %to[short] ++(0.1, 0) -|(opamp.out) to[short] ++(1, 0) node[ocirc, label={[yshift=0.3]$V_{out}$}]{}
        to[short] ++(0.1, 0) -|(opamp.out) to[short] ++(1, 0) node[ocirc, label=above:$V_{out}$]{};

        %Nodes
        \node[shift={(0,+1.5)}] at (opamp) {U6 HLM6658};
    \end{circuitikz}
    \caption{Amplifier circuit schematic.}
    \label{circ:amplifier}
\end{figure}

\section{Peak Detector}

The idea behind the peak detector is to store charge in a capacitor ($C25$) through a diode ($D3$), retaining the highest voltage the input signal reaches. A diode is placed before the capacitor so that once the signal's voltage goes below the peak voltage, the diode will be reverse biased, therefore preventing current from flowing while maintaining the voltage on the capacitor.

In order to measure the voltage in the capacitor, a discharging resistor has to be added ($R15/R19$). The time it takes the capacitor to discharge is given by $t=RC$. Although for example in the case of CosmicWatch-V2's peak detector, the values of $R14$ and $R24$ also play a role in the discharging time that hasn't proved to be as trivial as calculating the equivalent resistance $R_t$ of all three and simply take $t=R_tC$.

In order to test multiple peak-detector designs, the schematics and PCB shown in \href{https://github.com/anvargasl/CosmicWatch-gamma-spectroscopy-PCB}{CosmicWatch-gamma-spectroscopy-PCB}, include the connections and footprints necessary to place the components that make the designs illustrated in Subsections \labelcref{sec:basic,sec:basic_buffer,sec:nuclear_phoenix}.

\subsection{Basic Peak Detector}\label{sec:basic}
\begin{figure}[H]
    \centering
    \begin{circuitikz}[scale=0.8]
        \draw [help lines] (-4,0) grid (5,-4);
        \draw (0,0) node[op amp,yscale=-1] (opamp) {}
        (opamp.+) node[left]{$V_{in}$}
        (opamp.out) node[]{} to[sD, l_=$D_3$] (3.5, 0) coordinate (D3_r)
        (opamp.-) node[left]{} to[short] ++(0, -2) coordinate (R24_l)
        (R24_l) to[R, l_=$R_{24}$] (D3_r |- , |- R24_l) coordinate (R24_r)
        (D3_r) to[short] (R24_r)
        (D3_r) to[short] ++(1,0) coordinate (C25_u)
        (C25_u) to[C, l=$C_{25}$] ++(0,-2) node[ground]{}
        (C25_u) to[short] ++(2,0) to[R, l=$R_{15}$] ++(0,-2) node[ground]{};
        %\draw (A |- 52,3)(D3_r) -- (R24_r);
        % to[short] ++(-0.1, 0) -|(R24_r)

        %Nodes
        \node[shift={(0,+1.5)}] at (opamp) {U6 HLM6658};
    \end{circuitikz}
    \caption{Basic peak detector design, also used in previous versions of CosmicWatch detectors.}
    \label{circ:basic_pd}
\end{figure}


\subsection{Basic Peak Detector + Buffer}\label{sec:basic_buffer}

\subsection{Nuclear Phoenix}\label{sec:nuclear_phoenix}

\cite{Nucelar_phoenix}

\section{Trigger}

%add code as appendix
\section{Microcontroller}

\section{DC to DC booster}

\section{Single photons}